image: docker:stable
stages:
  - aws
  - build
  - test

aws:
  stage: aws
  image:
    name: amazon/aws-cli
    entrypoint: [""]
  script:
    - aws s3 ls
    - $(aws ecr get-login --no-include-email --region us-west-2)

build:
  stage: build
  when: manual
  services:
    - docker:dind
  script:
    - echo "starting docker build......."
    - ls
    - echo "$PASSWORD" | docker login -u "$USERNAME" --password-stdin
    - docker build -t cicd-test .
    - docker images
    - docker tag cicd-test shahedmehbub/cicd-test
    - docker push shahedmehbub/cicd-test

test:
  stage: test
  when: manual
  services:
    - docker:dind
  image: ictu/sshpass
  script:
          - sshpass -p hello123 ssh -o StrictHostKeyChecking=no cicduser@139.59.106.149 "docker stop cicd-test && docker rm cicd-test && docker rmi shahedmehbub/cicd-test && docker run -d --name cicd-test -p 5000:5000 shahedmehbub/cicd-test"
